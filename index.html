<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Grade My Finance</title>

<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-H6223HYVS6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-H6223HYVS6');
</script>

<style>
  :root{
    --ink:#0b1220; --muted:#5b6473; --card:#ffffff; --card-2:#f8fafc;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --accent:#22c55e; --accent-2:#16a34a; --ring:#bbf7d0;
    --r-lg:12px; --border:#e5e7eb; --border-soft:#ecfeff;
    --bg: radial-gradient(1200px 600px at 20% -10%, #a7f3d0, transparent 60%),
          radial-gradient(1200px 600px at 80% -20%, #bae6fd, transparent 60%),
          linear-gradient(135deg, #0ea5e9, #22d3ee 35%, #a7f3d0);
  }
  [data-theme="dark"]{
    --ink:#e5e7eb; --muted:#a6adbb; --card:#0f172a; --card-2:#111827;
    --ring:rgba(34,197,94,.25);
    --border:#1f2937; --border-soft:#0b1220;
    --bg: radial-gradient(1000px 500px at 10% -10%, #0b3b4a66, transparent 60%),
          radial-gradient(900px 500px at 90% -20%, #0c2a1566, transparent 60%),
          linear-gradient(135deg, #0b1021, #0b132b 35%, #0a1a24);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--bg);
    min-height:100vh; padding:28px 12px 48px; overflow-x:hidden;
    transition: background .3s ease, color .2s ease;
  }

  /* Header */
  .hero{
    position:relative; max-width:1100px; margin:0 auto 14px; padding:18px 18px 22px;
    border-radius: 12px;
    background: color-mix(in oklab, var(--card) 70%, transparent);
    backdrop-filter: blur(6px);
    border: 1px solid color-mix(in oklab, var(--card) 70%, var(--border));
    box-shadow: 0 10px 28px rgba(0,0,0,.10);
  }
  .hero-inner{display:flex; align-items:center; justify-content:space-between; gap:14px}
  .brand-wrap{display:flex; flex-direction:column; gap:6px; min-width:0; flex:1 1 auto;}
  .brand-logo{
    display:block; width:min(540px, 68vw); height:auto; max-height:64px; object-fit:contain;
    filter: drop-shadow(0 6px 14px rgba(14,165,233,.30));
  }
  .subtitle{margin:0; color:var(--muted); font-size:15px}
  .hero-actions{display:flex; align-items:center; gap:10px}
  .toggle{
    display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px;
    border:1px solid var(--border); background:var(--card-2); color:var(--ink); cursor:pointer;
    font-weight:600; font-size:13px;
  }
  .streak{font-weight:800; font-size:12px; padding:6px 10px; border-radius:999px; background:#e6fce9; color:#065f46; border:1px solid #bbf7d0}
  [data-theme="dark"] .streak{background:#0b2f1f; color:#bbf7d0; border-color:#164e3a}
  .hero-stripe{
    position:absolute; inset:auto 0 0 0; height:6px; border-radius:0 0 12px 12px;
    background: linear-gradient(90deg,#0ea5e9,#22c55e,#84cc16,#06b6d4,#0ea5e9);
    background-size: 300% 100%;
    animation: flow 8s linear infinite;
  }
  @keyframes flow{0%{background-position:0% 0}100%{background-position:300% 0}}

  /* App card */
  .wrap{
    position:relative; z-index:1;
    max-width:1100px; margin:0 auto; background:var(--card); padding:22px;
    border-radius: 12px; border:1px solid var(--border-soft);
    box-shadow: 0 12px 32px rgba(0,0,0,.12);
  }
  .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:14px}
  .field{grid-column:span 12; background:var(--card-2); border:1px solid var(--border); border-radius:8px; padding:12px}
  @media (min-width:760px){
    .span-6{grid-column:span 6}.span-4{grid-column:span 4}.span-3{grid-column:span 3}.span-9{grid-column:span 9}
  }
  label{display:block; font-weight:600; margin-bottom:6px}
  input, select{
    width:100%; font:inherit; padding:10px 12px; border-radius:6px;
    border:1px solid var(--border); background:var(--card); color:var(--ink);
    transition:border .15s, box-shadow .15s
  }
  input:focus, select:focus{outline:none; border-color:var(--accent); box-shadow:0 0 0 4px var(--ring)}
  .hint{font-size:12px; color:var(--muted); margin-top:6px}
  .sec{margin-top:8px; background:var(--card); border:1px dashed color-mix(in oklab, var(--border) 60%, transparent); border-radius:8px; padding:12px}
  .sec h3{margin:0 0 8px; font-size:16px; display:flex; align-items:center; gap:8px}

  .actions{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top:10px}
  button{appearance:none; border:0; cursor:pointer; padding:11px 16px; border-radius:8px; font-weight:800;
    background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#052e16;
    box-shadow:0 8px 18px rgba(34,197,94,.28); transform:translateY(0); transition:transform .1s}
  [data-theme="dark"] button{color:#052e16}
  button:active{transform:translateY(1px)}
  .secondary{background:#e5e7eb; color:#111827; box-shadow:none}
  [data-theme="dark"] .secondary{background:#1f2937; color:#e5e7eb}
  .linkish{border:1px solid var(--border); background:var(--card-2); color:var(--ink); font-weight:700}

  .scorecard{margin-top:16px; padding:16px; border-radius:8px; background:color-mix(in oklab, var(--card) 80%, transparent); border:1px solid var(--border);
    display:grid; grid-template-columns:1fr; gap:12px}
  .grade{font-family:"Baloo 2", cursive; font-size: clamp(26px, 4vw, 42px); font-weight:800}
  .muted{color:var(--muted)} .tiny{font-size:12px}
  .meters{display:grid; gap:10px}
  .meter{background:var(--card); padding:12px; border:1px solid var(--border); border-radius:8px}
  .meter h4{margin:0 0 6px; font-size:14px}
  .bar{height:10px; background:color-mix(in oklab, var(--border) 65%, transparent); border-radius:6px; overflow:hidden}
  .bar > i{display:block; height:100%; width:0%; border-radius:6px; transition: width .6s cubic-bezier(.2,.8,.2,1)}
  .pos i{background:var(--ok)} .mid i{background:var(--warn)} .neg i{background:var(--bad)}
  .tips,.explain{background:var(--card); border:1px solid var(--border); border-radius:8px; padding:14px}
  .footer{margin-top:6px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap}
  .pulse{animation: pulse .8s ease-out}
  @keyframes pulse{0%{transform:scale(1)}40%{transform:scale(1.05); text-shadow:0 0 12px color-mix(in oklab, var(--ok) 60%, transparent)}100%{transform:scale(1)}}
  #confettiCanvas{position:fixed; inset:0; pointer-events:none; z-index:9999; display:none}

  /* Suspense / Reveal overlay */
  .reveal{
    position:fixed; inset:0; z-index:9998; display:none;
    background:rgba(0,10,20,0.65); backdrop-filter: blur(2px);
    align-items:center; justify-content:center;
  }
  .reveal.show{display:flex}
  .reveal-card{
    background:var(--card); color:var(--ink); border:1px solid var(--border);
    border-radius:14px; padding:22px; width:min(560px,92vw);
    box-shadow:0 18px 40px rgba(0,0,0,.35); text-align:center;
  }
  .reveal-title{font-weight:800; font-size:18px; margin:0 0 10px}
  .reveal-bar{height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin:8px 0 6px}
  .reveal-bar > i{display:block; height:100%; width:0; background:linear-gradient(90deg,#0ea5e9,#22c55e); animation: fill 3s linear forwards}
  @keyframes fill{to{width:100%}}
  .reveal-grade{
    margin-top:14px; font-family:"Baloo 2", cursive; font-size: clamp(42px, 7vw, 72px);
    font-weight:800; letter-spacing:.5px; opacity:0; transform: translateX(25px);
    transition: all .5s cubic-bezier(.2,.8,.2,1);
  }
  .reveal-grade.show{opacity:1; transform: translateX(0)}

  /* Toast */
  .toast{
    position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
    background:#111827; color:#f9fafb; border-radius:999px; padding:8px 14px; font-weight:700; font-size:13px;
    box-shadow:0 8px 24px rgba(0,0,0,.35); z-index:9999; display:none
  }
  .toast.show{display:block}
</style>
</head>

<body>
  <!-- Header with wide logo -->
  <section class="hero">
    <div class="hero-inner">
      <div class="brand-wrap">
        <img class="brand-logo" src="./logo-wordmark.png" alt="Grade My Finance" />
        <p class="subtitle">A playful, educational snapshot of your money health — with tiers to rank up.</p>
      </div>
      <div class="hero-actions">
        <span id="streakBadge" class="streak" title="Visit streak">🔥 1-day streak</span>
        <button class="toggle" id="themeToggle" aria-label="Toggle dark mode">🌙 <span id="themeLabel">Dark</span></button>
      </div>
    </div>
    <div class="hero-stripe"></div>
  </section>

  <main class="wrap">
    <!-- Quick fields -->
    <section class="grid">
      <div class="field span-4">
        <label for="income">Monthly Income (after-tax)</label>
        <input type="number" id="income" min="0" step="100">
        <div class="hint">What hits your bank each month.</div>
      </div>
      <div class="field span-4">
        <label for="expenses">Monthly Expenses</label>
        <input type="number" id="expenses" min="0" step="50">
        <div class="hint">All bills + spending.</div>
      </div>
      <div class="field span-4">
        <label for="cash">Cash Savings</label>
        <input type="number" id="cash" min="0" step="100">
        <div class="hint">Checking + savings + HYSA (also counted in Assets).</div>
      </div>
    </section>

    <!-- Assets & Liabilities -->
    <section class="grid">
      <div class="field span-6">
        <div class="sec">
          <h3>Assets 💰</h3>
          <div class="grid">
            <div class="field span-6"><label for="asset_home">Home Value</label><input type="number" id="asset_home" placeholder="e.g., 460000"></div>
            <div class="field span-6"><label for="asset_retire">Retirement (401k/IRA)</label><input type="number" id="asset_retire" placeholder="e.g., 61000"></div>
            <div class="field span-6"><label for="asset_broker">Brokerage/Stocks</label><input type="number" id="asset_broker" placeholder="e.g., 17400"></div>
            <div class="field span-6"><label for="asset_car">Car Value</label><input type="number" id="asset_car" placeholder="e.g., 2500"></div>
          </div>
          <div class="hint">Leave blanks if not applicable — they count as 0.</div>
          <div class="hint"><strong>Total Assets:</strong> $<span id="assets_total">0</span></div>
        </div>
      </div>

      <div class="field span-6">
        <div class="sec">
          <h3>Liabilities 🧾</h3>
          <div class="grid">
            <div class="field span-6"><label for="debt_mortgage">Mortgage Balance</label><input type="number" id="debt_mortgage" placeholder="e.g., 329000"></div>
            <div class="field span-6"><label for="debt_student">Student Loans</label><input type="number" id="debt_student" placeholder="e.g., 26000"></div>
            <div class="field span-6"><label for="debt_auto">Auto Loans</label><input type="number" id="debt_auto" placeholder="e.g., 13500"></div>
            <div class="field span-6"><label for="debt_cards">Credit Cards</label><input type="number" id="debt_cards" placeholder="e.g., 3300"></div>
            <div class="field span-12"><label for="debt_other">Other Debt</label><input type="number" id="debt_other" placeholder="e.g., 0"></div>
          </div>
          <div class="hint"><strong>Total Liabilities:</strong> $<span id="liabs_total">0</span></div>
        </div>
      </div>

      <div class="field span-3">
        <label for="age">Age</label>
        <input type="number" id="age" min="14" max="90" step="1">
        <div class="hint">Used for retirement readiness benchmarks.</div>
      </div>
      <div class="field span-9">
        <label for="name">Nickname (optional)</label>
        <input type="text" id="name" placeholder="e.g., Aaron">
      </div>
    </section>

    <!-- Profiles -->
    <section class="profiles" style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
      <select id="profileSelect">
        <option value="">Load saved profile…</option>
      </select>
      <input id="profileName" placeholder="Profile name (e.g., Me)" style="max-width:220px">
      <button class="secondary linkish" id="saveProfileBtn">Save profile</button>
      <button class="secondary linkish" id="deleteProfileBtn">Delete profile</button>
    </section>

    <div class="actions">
      <button id="gradeBtn">Grade Me!</button>
      <button class="secondary" id="resetBtn">Reset</button>
      <button class="secondary linkish" id="clearDataBtn" title="Forget saved inputs">Clear my data</button>
      <button class="secondary linkish" id="copyLinkBtn" title="Copy sharable link">Copy sharable link</button>
      <button class="secondary linkish" id="shortLinkBtn" title="Shorten & copy link">Shorten & copy link</button>
      <span class="linkish" style="padding:6px 10px; font-size:12px; border-radius:999px">Educational only — not financial advice</span>
    </div>

    <!-- Results -->
    <section id="results" class="scorecard" style="display:none;">
      <div class="grade" id="letter"></div>
      <div><strong>Score:</strong> <span id="score">—</span>/100</div>
      <div class="muted tiny" id="deltaLine">—</div>
      <div class="muted tiny" id="whyLine">—</div>

      <div class="meters" id="meters"></div>

      <div class="result-actions" style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="shareBtn" class="secondary linkish">Share my grade</button>
        <button id="saveImgBtn" class="secondary linkish">Download result (PNG)</button>
      </div>

      <div class="tips">
        <h3>Quick Tips to Rank Up</h3>
        <ul id="tipsList"></ul>
      </div>

      <div class="explain">
        <h3>What your numbers mean</h3>
        <ul id="explainList" class="muted"></ul>
        <details class="tiny" style="margin-top:8px">
          <summary><strong>Scoring bands used</strong></summary>
          <p><strong>Savings rate</strong> (income − expenses) ÷ income. 20–40% earns most points. (25 pts)</p>
          <p><strong>Spending control</strong> 1 − (expenses ÷ income). ≥40% “leftover” is best. (10 pts)</p>
          <p><strong>Debt-to-income</strong> total debt ÷ annual income. Lower is better. (15 pts) + extreme penalty caps.</p>
          <p><strong>Emergency fund</strong> 0, 1, 3, 6 months are the breakpoints. (15 pts)</p>
          <p><strong>Retirement readiness</strong> investable assets ÷ (age target × income). Uses age-target multiples. (35 pts)</p>
        </details>
      </div>

      <!-- What-If Lab -->
      <div class="tips">
        <h3>What-If Lab (12-month preview)</h3>
        <div class="grid">
          <div class="field span-4">
            <label>Change monthly expenses</label>
            <input type="range" min="0.8" max="1.2" step="0.01" id="w_expFactor">
            <div class="tiny muted">Current × <span id="w_expFactor_val">1.00</span></div>
          </div>
          <div class="field span-4">
            <label>Extra monthly savings</label>
            <input type="number" id="w_extraSave" min="0" step="25" value="0">
            <div class="tiny muted">Adds to cash (and 25% counts as investable).</div>
          </div>
          <div class="field span-4">
            <label>Extra monthly debt payoff</label>
            <input type="number" id="w_extraDebt" min="0" step="25" value="0">
            <div class="tiny muted">Reduces total liabilities over 12 months.</div>
          </div>
        </div>
        <button class="secondary linkish" id="w_run">Preview</button>
        <div id="w_result" class="tiny muted" style="margin-top:8px">Adjust sliders and preview your future grade.</div>
      </div>

      <div class="footer muted tiny">
        <div id="summary"></div>
        <div>© <span id="yr"></span> Grade My Finance</div>
      </div>
    </section>
  </main>

  <!-- Suspense/Reveal Overlay -->
  <div id="revealOverlay" class="reveal" aria-hidden="true">
    <div class="reveal-card">
      <p class="reveal-title">Crunching numbers…</p>
      <div class="reveal-bar"><i id="revealFill"></i></div>
      <div id="revealGrade" class="reveal-grade">A</div>
    </div>
  </div>

  <div id="toast" class="toast">Cleaned nickname for profanity</div>
  <canvas id="confettiCanvas"></canvas>

<script>
(function(){
  const $ = id => document.getElementById(id);
  $('yr').textContent = new Date().getFullYear();

  /* ---------- Visit streak ---------- */
  const streakKey = 'gmf_streak';
  const now = new Date(); const today = new Date(now.getFullYear(),now.getMonth(),now.getDate()).getTime();
  let streak = JSON.parse(localStorage.getItem(streakKey)||'{"count":0,"last":0}');
  const diffDays = streak.last ? Math.floor((today - streak.last)/86400000) : null;
  if(diffDays===0){} else if(diffDays===1){ streak.count++; streak.last=today; } else { streak={count:1,last:today}; }
  localStorage.setItem(streakKey, JSON.stringify(streak));
  $('streakBadge').textContent = `🔥 ${streak.count}-day streak`;

  /* ---------- Theme ---------- */
  const root = document.documentElement;
  const themeToggle = $('themeToggle');
  const themeLabel = $('themeLabel');
  const storedTheme = localStorage.getItem('gmf_theme');
  if(storedTheme){ root.setAttribute('data-theme', storedTheme); themeLabel.textContent = storedTheme==='dark'?'Light':'Dark'; }
  themeToggle.addEventListener('click', ()=>{
    const cur = root.getAttribute('data-theme')==='dark' ? 'light' : 'dark';
    root.setAttribute('data-theme', cur);
    localStorage.setItem('gmf_theme', cur);
    themeLabel.textContent = cur==='dark' ? 'Light' : 'Dark';
  });

  /* ---------- Inputs / totals ---------- */
  const inputIds = ['income','expenses','cash','asset_home','asset_retire','asset_broker','asset_car','debt_mortgage','debt_student','debt_auto','debt_cards','debt_other','age','name'];
  const assetIds = ['asset_home','asset_retire','asset_broker','asset_car'];
  const debtIds  = ['debt_mortgage','debt_student','debt_auto','debt_cards','debt_other'];

  function toNum(el){ const n = Number((el.value||'').replace(/,/g,'')); return isNaN(n)?0:n; }
  function num(id){ return toNum($(id)); }
  function fmt(v){ return Number(Math.round(v)).toLocaleString(); }

  function updateTotals(){
    const assets = assetIds.reduce((a,id)=>a+num(id),0) + num('cash');
    const liabs  = debtIds.reduce((a,id)=>a+num(id),0);
    $('assets_total').textContent = assets.toLocaleString();
    $('liabs_total').textContent  = liabs.toLocaleString();
  }
  [...assetIds, ...debtIds, 'cash'].forEach(id => $(id).addEventListener('input', ()=>{ updateTotals(); saveInputs(); }));
  inputIds.forEach(id => $(id).addEventListener('input', saveInputs));

  function saveInputs(){
    const data = {}; inputIds.forEach(id => data[id] = ($(id).value || ''));
    localStorage.setItem('gmf_inputs', JSON.stringify(data));
  }
  function loadInputs(){
    const url = new URL(location.href);
    if(url.searchParams.get('q')){
      try{
        const data = JSON.parse(decodeURIComponent(atob(url.searchParams.get('q'))));
        Object.keys(data).forEach(id => { if($(id)) $(id).value = data[id]; });
      }catch(e){}
    }else{
      const raw = localStorage.getItem('gmf_inputs'); if(!raw) return;
      try{ const data = JSON.parse(raw); Object.keys(data).forEach(id => { if($(id)) $(id).value = data[id]; }); }catch(e){}
    }
  }
  loadInputs(); updateTotals();

  /* ---------- Profiles ---------- */
  const pKey = 'gmf_profiles';
  function getProfiles(){ return JSON.parse(localStorage.getItem(pKey) || '{}'); }
  function setProfiles(p){ localStorage.setItem(pKey, JSON.stringify(p)); refreshProfileList(); }
  function refreshProfileList(){
    const sel=$('profileSelect'); sel.innerHTML='<option value="">Load saved profile…</option>';
    const p=getProfiles(); Object.keys(p).forEach(name=>{
      const o=document.createElement('option'); o.value=name; o.textContent=name; sel.appendChild(o);
    });
  }
  refreshProfileList();
  $('saveProfileBtn').onclick=()=>{
    const name=$('profileName').value.trim() || 'Profile';
    const data={}; inputIds.forEach(id=>data[id]=($(id).value||''));
    const p=getProfiles(); p[name]=data; setProfiles(p);
    $('profileName').value=''; toast('Profile saved.');
  };
  $('deleteProfileBtn').onclick=()=>{
    const name=$('profileSelect').value; if(!name) return toast('Select a saved profile first.');
    const p=getProfiles(); delete p[name]; setProfiles(p); toast('Profile deleted.');
  };
  $('profileSelect').onchange=()=>{
    const name=$('profileSelect').value; if(!name) return;
    const p=getProfiles()[name]; if(!p) return;
    Object.keys(p).forEach(id=>{ if($(id)) $(id).value=p[id]; });
    updateTotals(); saveInputs();
  };

  /* ---------- Sharable link ---------- */
  function buildSharePayload(){
    const data = {};
    inputIds.forEach(id => data[id] = ($(id).value || ''));
    const q = btoa(encodeURIComponent(JSON.stringify(data))); /* FIXED */
    return `${location.origin}${location.pathname}?q=${q}`;
  }
  $('copyLinkBtn').onclick = () => {
    const link = buildSharePayload();
    navigator.clipboard.writeText(link).then(()=> toast('Link copied!'));
  };
  $('shortLinkBtn').onclick = async () => {
    const longUrl = buildSharePayload();
    try{
      const res = await fetch(`https://is.gd/create.php?format=simple&url=${encodeURIComponent(longUrl)}`);
      const txt = await res.text();
      if(/^https?:\/\//.test(txt.trim())){
        await navigator.clipboard.writeText(txt.trim());
        toast('Short link copied!');
      }else{
        await navigator.clipboard.writeText(longUrl);
        toast('Couldn’t shorten, copied full link.');
      }
    }catch(e){
      await navigator.clipboard.writeText(longUrl);
      toast('Shortener blocked; copied full link.');
    }
  };

  /* ---------- Profanity filter (nickname) ---------- */
  const BAD = [
    "ass","bastard","bitch","bollock","cock","cunt","dick","dyke","fuck","fucking",
    "hoe","jackass","motherfucker","prick","pussy","shit","slut","twat"
  ];
  function cleanNickname(raw){
    if(!raw) return {clean:"", filtered:false, replacedAll:false};
    const tokens = raw.split(/\s+/).map(t=>{
      let out=t; BAD.forEach(w=>{ out = out.replace(new RegExp(w,'ig'),'***'); });
      return out;
    });
    const clean = tokens.join(' ').trim();
    const filtered = clean!==raw;
    const allGone = clean.replace(/[*\s]/g,'').length===0;
    return {clean: allGone ? 'Friend' : clean, filtered, replacedAll: allGone};
  }

  /* ---------- Suspense flow ---------- */
  const overlay=$('revealOverlay'), rGrade=$('revealGrade'), rFill=$('revealFill');
  let revealing = false;
  async function gradeFlow(){
    if(revealing) return; revealing=true;

    // reset overlay visuals
    rGrade.textContent = '';
    rGrade.classList.remove('show');
    rFill.style.animation = 'none'; void rFill.offsetWidth; rFill.style.animation = null;

    overlay.classList.add('show');

    // wait for the 3s progress bar to finish
    await new Promise(resolve=>{
      const onEnd = ()=>{ rFill.removeEventListener('animationend', onEnd); resolve(); };
      rFill.addEventListener('animationend', onEnd);
    });

    // sanitize nickname
    const nickRaw = $('name').value.trim();
    const {clean, filtered} = cleanNickname(nickRaw);
    if(filtered) toast('Cleaned nickname for profanity');
    $('name').value = clean;

    // compute + render
    const letter = computeAndRender();

    // reveal grade
    rGrade.textContent = letter;
    requestAnimationFrame(()=> rGrade.classList.add('show'));

    await new Promise(r => setTimeout(r, 900));
    overlay.classList.remove('show');
    rGrade.classList.remove('show');
    revealing=false;

    // scroll to results
    $('results').scrollIntoView({behavior:'smooth', block:'start'});
  }

  const gradeBtn=$('gradeBtn'), resetBtn=$('resetBtn'), results=$('results');
  gradeBtn.onclick = gradeFlow;
  // Enter key to grade
  document.addEventListener('keydown', e=>{ if(e.key==='Enter') gradeBtn.click(); });

  resetBtn.onclick = () => { inputIds.forEach(id=>$(id).value=''); updateTotals(); results.style.display='none'; };

  $('clearDataBtn').onclick = () => {
    localStorage.removeItem('gmf_inputs'); inputIds.forEach(id=>$(id).value='');
    updateTotals(); results.style.display='none';
  };

  /* ---------- Scoring helpers ---------- */
  function piecewise(x, pts){
    pts = pts.slice().sort((a,b)=>a[0]-b[0]);
    if(x<=pts[0][0]) return pts[0][1];
    if(x>=pts[pts.length-1][0]) return pts[pts.length-1][1];
    for(let i=0;i<pts.length-1;i++){
      const [x1,y1]=pts[i], [x2,y2]=pts[i+1];
      if(x>=x1 && x<=x2){ const t=(x-x1)/(x2-x1); return y1 + t*(y2-y1); }
    } return 0;
  }
  function piecewiseRev(x, pts){
    pts = pts.slice().sort((a,b)=>a[0]-b[0]);
    if(x<=pts[0][0]) return pts[0][1];
    if(x>=pts[pts.length-1][0]) return pts[pts.length-1][1];
    for(let i=0;i<pts.length-1;i++){
      const [x1,y1]=pts[i], [x2,y2]=pts[i+1];
      if(x>=x1 && x<=x2){ const t=(x-x1)/(x2-x1); return y1 + t*(y2-y1); }
    } return 0;
  }
  function targetRetMultipleByAge(age){
    const pts = [[25,0.5],[30,1],[35,2],[40,3],[45,4],[50,6],[55,7],[60,8],[65,10]];
    age = Math.max(18, Math.min(75, age||30));
    if(age<=pts[0][0]) return pts[0][1];
    for(let i=0;i<pts.length-1;i++){
      const [a1,m1]=pts[i], [a2,m2]=pts[i+1];
      if(age>=a1 && age<=a2){ const t=(age-a1)/(a2-a1); return m1 + t*(m2-m1); }
    } return pts[pts.length-1][1];
  }
  function toLetter(score){
    const bands = [
      {min: 97, label:'A+'},
      {min: 93, label:'A'},
      {min: 90, label:'A-'},
      {min: 87, label:'B+'},
      {min: 83, label:'B'},
      {min: 80, label:'B-'},
      {min: 77, label:'C+'},
      {min: 73, label:'C'},
      {min: 70, label:'C-'},
      {min: 67, label:'D+'},
      {min: 60, label:'D'},
      {min:-999,label:'F'}
    ];
    const cur = bands.find(b=>score>=b.min);
    const idx = bands.indexOf(cur);
    return {letter:cur.label, index:idx};
  }
  function gradeDelta(score){
    const T = [97,93,90,87,83,80,77,73,70,67,60,0];
    let up = T.find(t => score < t); if(up===undefined) up = 100;
    const down = T.slice().reverse().find(t => score >= t) || 0;
    return { toNext: Math.max(0, Math.ceil(up - score)),
             toDown: Math.max(0, Math.ceil(score - down)) };
  }

  /* ---------- Main compute ---------- */
  const confettiCanvas = $('confettiCanvas'); const ctx2 = confettiCanvas.getContext('2d');
  let prevLetterIdx = null;

  function computeAndRender(){
    const income = num('income'), expenses=num('expenses'), cash=num('cash');
    const age = num('age') || 30; const name = $('name').value.trim();

    const retire = num('asset_retire'), broker = num('asset_broker'), home = num('asset_home'), car = num('asset_car');
    const assets = retire + broker + home + car + cash;
    const liabilities = ['debt_mortgage','debt_student','debt_auto','debt_cards','debt_other'].reduce((a,id)=>a+num(id),0);

    const annualIncome = income*12;
    const netWorth = assets - liabilities;
    const savings = Math.max(0, income - expenses);
    const savingsRate = income>0 ? savings/income : 0;
    const expenseRatio = income>0 ? expenses/income : 1;
    const dti = annualIncome>0 ? (liabilities/annualIncome) : 99;
    const monthsEF = expenses>0 ? cash/expenses : 0;

    // Retirement readiness
    const investable = retire + broker + 0.25*cash;
    const targetMultiple = targetRetMultipleByAge(age);
    const targetAmount = (annualIncome>0 ? targetMultiple*annualIncome : Infinity);
    const readiness = (annualIncome>0 && isFinite(targetAmount) && targetAmount>0) ? Math.min(1, investable/targetAmount) : 0;

    // Base scores
    const scoreSavingsRate = piecewise(savingsRate, [[0.00,0],[0.10,12],[0.20,20],[0.30,23],[0.40,25]]);
    const scoreExpense     = piecewise(1-expenseRatio, [[0.00,0],[0.10,3],[0.20,6],[0.30,8],[0.40,10]]);
    const scoreDTI         = piecewiseRev(dti, [[3.00,0],[2.00,4],[1.50,8],[1.00,11],[0.50,13],[0.25,15]]);
    const scoreEF          = piecewise(monthsEF, [[0,0],[1,5],[3,11],[6,15]]);
    const scoreRet         = readiness*35;

    let total = scoreSavingsRate + scoreExpense + scoreDTI + scoreEF + scoreRet;
    let notes = [];

    // Extra penalties
    if(dti>3){
      const pen = Math.min(30, (dti-3)*6); // grows fast
      total -= pen;
      notes.push(`DTI extreme penalty −${pen.toFixed(0)}`);
    }
    if(netWorth < 0){
      const penNW = annualIncome>0 ? Math.min(25, (-netWorth/annualIncome)*25) : 15;
      total -= penNW;
      notes.push(`Negative net worth penalty −${penNW.toFixed(0)}`);
    }

    // Hard caps
    let cap=null;
    if(dti>10){ total = Math.min(total, 45); cap='Debt-to-income too high (>10×) — score capped.'; }
    else if(dti>6){ total = Math.min(total, 60); cap='Debt-to-income very high (>6×) — score capped.'; }
    if(annualIncome>0 && netWorth < -annualIncome){
      total = Math.min(total, 62);
      cap = (cap? cap+' ':'') + 'Net worth below −1× annual income — score capped.';
    }

    total = Math.max(0, Math.min(100, Math.round(total)));
    const g = toLetter(total);
    const delta = gradeDelta(total);

    const results=$('results');
    results.style.display='grid';
    const letterEl = $('letter');
    letterEl.textContent = (name? `${name}, `:'') + `Your grade: ${g.letter}`;
    $('score').textContent = total;
    $('deltaLine').textContent = `▲ ${delta.toNext} pts to rank up • ▼ ${delta.toDown} pts to drop`;
    $('whyLine').textContent = `Net worth: $${fmt(netWorth)} • Savings rate: ${(savingsRate*100).toFixed(0)}% • EF: ${monthsEF.toFixed(1)} mo • DTI: ${dti.toFixed(2)}× • Retirement target: ${targetMultiple.toFixed(1)}× income`;

    const parts = [
      {key:'Savings rate', score:scoreSavingsRate, max:25},
      {key:'Spending control', score:scoreExpense, max:10},
      {key:'Debt vs income', score:scoreDTI, max:15},
      {key:'Emergency fund', score:scoreEF, max:15},
      {key:'Retirement readiness', score:scoreRet, max:35}
    ];
    const meters = $('meters'); meters.innerHTML='';
    parts.forEach(p=>{
      const pct = Math.max(0, Math.min(1, p.score/p.max));
      const cls = pct>=0.66 ? 'pos' : pct>=0.33 ? 'mid' : 'neg';
      const wrap = document.createElement('div'); wrap.className='meter';
      wrap.innerHTML = `<h4>${p.key} <span class="muted tiny">(${Math.round(p.score)}/${p.max})</span></h4>
                        <div class="bar ${cls}"><i style="width:${Math.max(4, Math.round(pct*100))}%;"></i></div>`;
      meters.appendChild(wrap);
    });

    // Tips & explanations
    const tips = buildTips({savingsRate, expenseRatio, dti, monthsEF, investable, targetAmount, annualIncome});
    $('tipsList').innerHTML = tips.slice(0,5).map(t=>`<li>${t}</li>`).join('');
    const explain = buildExplain({income, expenses, cash, liabilities, annualIncome, netWorth, dti, savingsRate, monthsEF, investable, targetMultiple});
    if(cap) explain.unshift(cap);
    if(notes.length) explain.unshift(...notes);
    $('explainList').innerHTML = explain.map(t=>`<li>${t}</li>`).join('');

    $('summary').textContent = `This score uses simple heuristics — directional, not prescriptive.`;
    saveInputs();

    $('shareBtn').onclick = () => {
      const url = location.origin + location.pathname;
      const text = `I got a ${g.letter} on Grade My Finance! (${total}/100)`;
      const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
      window.open(shareUrl, '_blank');
    };
    $('saveImgBtn').onclick = async () => {
      const node = $('results');
      const canvas = await html2canvas(node, {backgroundColor: null, scale: 2});
      const link = document.createElement('a');
      link.download = `grade-my-finance-${g.letter}-${total}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    };

    // Confetti if improved
    const idx = g.index;
    if(prevLetterIdx===null){ prevLetterIdx = idx; }
    else if(idx > prevLetterIdx){ $('letter').classList.remove('pulse'); void $('letter').offsetWidth; $('letter').classList.add('pulse'); runConfetti(1200); prevLetterIdx = idx; } 
    else { prevLetterIdx = idx; }

    if(window.gtag){ window.gtag('event','grade_calculated',{ grade_letter:g.letter, score: total }); }

    return g.letter; // for reveal overlay
  }

  /* ---------- What-If Lab ---------- */
  const expSlider=$('w_expFactor'), expLabel=$('w_expFactor_val');
  expSlider.addEventListener('input', ()=> expLabel.textContent = Number(expSlider.value).toFixed(2));
  $('w_run').onclick = ()=>{
    const expF = Number(expSlider.value||'1');
    const extraSave = Number($('w_extraSave').value||0);
    const extraDebt = Number($('w_extraDebt').value||0);

    const income = num('income'), expenses=num('expenses')*expF, cash=num('cash') + extraSave*12;
    const age = num('age') || 30;
    const retire = num('asset_retire'), broker = num('asset_broker'), home = num('asset_home'), car = num('asset_car');
    let liabilities = ['debt_mortgage','debt_student','debt_auto','debt_cards','debt_other'].reduce((a,id)=>a+num(id),0);
    liabilities = Math.max(0, liabilities - extraDebt*12);

    const annualIncome = income*12;
    const savings = Math.max(0, income - expenses);
    const savingsRate = income>0 ? savings/income : 0;
    const expenseRatio = income>0 ? expenses/income : 1;
    const dti = annualIncome>0 ? (liabilities/annualIncome) : 99;
    const monthsEF = expenses>0 ? cash/expenses : 0;
    const investable = retire + broker + 0.25*cash;
    const targetMultiple = targetRetMultipleByAge(age);
    const readiness = (annualIncome>0 && isFinite(income) && targetMultiple>0) ? Math.min(1, investable/(targetMultiple*annualIncome)) : 0;

    const scoreSavingsRate = piecewise(savingsRate, [[0.00,0],[0.10,12],[0.20,20],[0.30,23],[0.40,25]]);
    const scoreExpense     = piecewise(1-expenseRatio, [[0.00,0],[0.10,3],[0.20,6],[0.30,8],[0.40,10]]);
    const scoreDTI         = piecewiseRev(dti, [[3.00,0],[2.00,4],[1.50,8],[1.00,11],[0.50,13],[0.25,15]]);
    const scoreEF          = piecewise(monthsEF, [[0,0],[1,5],[3,11],[6,15]]);
    const scoreRet         = readiness*35;
    let total = Math.round(scoreSavingsRate+scoreExpense+scoreDTI+scoreEF+scoreRet);

    if(dti>3){ total -= Math.min(30, (dti-3)*6); }
    if(dti>10) total = Math.min(total, 45);
    else if(dti>6) total = Math.min(total, 60);

    const letter = toLetter(Math.max(0, Math.min(100, total))).letter;
    $('w_result').textContent = `With those changes for 12 months: grade ≈ ${letter} (${Math.max(0, Math.min(100, total))}/100).`;
  };

  /* ---------- Tips / Explain ---------- */
  function buildTips({savingsRate, expenseRatio, dti, monthsEF, investable, targetAmount, annualIncome}){
    const t=[];
    if(monthsEF<3) t.push(`Build your emergency fund to 3+ months (you’re at ${monthsEF.toFixed(1)}). Auto-save $${Math.round(Math.max(100, (annualIncome/12)*0.05))}/mo.`);
    if(savingsRate<0.2) t.push(`Boost savings rate to 20%+. Cutting $${Math.round((annualIncome/12)*0.05)} in monthly spend will push you up a grade quickly.`);
    if(expenseRatio>0.7) t.push(`Expenses are ${(expenseRatio*100).toFixed(0)}% of income. Aim ≤65% to free more for investing.`);
    if(dti>2) t.push(`Debt ≈ ${dti.toFixed(1)}× your annual income. Consider accelerating highest-interest balances or refinancing.`);
    if(isFinite(targetAmount) && targetAmount>0 && investable/targetAmount<1){
      const gap = Math.max(0, targetAmount - investable);
      t.push(`Retirement readiness gap: ~$${fmt(gap)} to hit your age target. Automate contributions and invest consistently.`);
    }
    if(t.length===0) t.push('You’re crushing it — consider stretch goals: 6-month EF, +1% contribution bump, or a quarterly net-worth target.');
    return t;
  }
  function buildExplain({income, expenses, cash, liabilities, annualIncome, netWorth, dti, savingsRate, monthsEF, investable, targetMultiple}){
    const pct = x => (x*100).toFixed(1) + '%';
    const keepPct = income>0 ? 1 - (expenses/income) : 0;
    return [
      `Savings rate = (income − expenses) ÷ income = ${pct(savingsRate)}.`,
      `Spending control = 1 − (expenses ÷ income) = ${pct(keepPct)} kept after bills.`,
      `Debt-to-income = total debt ÷ annual income = $${fmt(liabilities)} ÷ $${fmt(annualIncome)} = ${dti.toFixed(2)}×.`,
      `Emergency fund months = cash ÷ monthly expenses = $${fmt(cash)} ÷ $${fmt(expenses)} = ${monthsEF.toFixed(1)} months.`,
      `Retirement readiness = investable assets ÷ (target multiple × income). Investable = retirement + brokerage + 25% of cash. Target multiple by age ≈ ${targetMultiple.toFixed(1)}×.`,
      `Net worth = assets − liabilities = $${fmt(investable + (home||0) + (car||0) + (cash||0))} − $${fmt(liabilities)} = $${fmt(netWorth)}.`
    ];
  }

  /* ---------- Toast ---------- */
  let toastTimer=null;
  function toast(msg){
    const t=$('toast'); t.textContent=msg; t.classList.add('show');
    clearTimeout(toastTimer); toastTimer=setTimeout(()=> t.classList.remove('show'), 2200);
  }

  /* ---------- Confetti ---------- */
  function runConfetti(durationMs=1200){
    const c=$('confettiCanvas'); const ctx=c.getContext('2d');
    function resize(){ c.width=window.innerWidth; c.height=window.innerHeight; }
    resize(); window.addEventListener('resize', resize);
    const colors = ['#22c55e','#0ea5e9','#84cc16','#06b6d4','#f59e0b','#ef4444'];
    const N = Math.min(220, Math.floor(window.innerWidth/6));
    const parts = Array.from({length:N}, ()=>({
      x: Math.random()*c.width, y: -20 - Math.random()*80, r: 4 + Math.random()*6,
      color: colors[Math.floor(Math.random()*colors.length)],
      vy: 3 + Math.random()*3, vx: -2 + Math.random()*4,
      rot: Math.random()*360, vr: -6 + Math.random()*12,
      shape: Math.random()<0.5 ? 'rect' : 'circle'
    }));
    c.style.display='block';
    const start = performance.now();
    requestAnimationFrame(function frame(t){
      const elapsed = t - start; ctx.clearRect(0,0,c.width,c.height);
      parts.forEach(p=>{
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180);
        ctx.fillStyle=p.color;
        if(p.shape==='rect'){ ctx.fillRect(-p.r,-p.r/2,p.r*2,p.r); }
        else{ ctx.beginPath(); ctx.arc(0,0,p.r,0,Math.PI*2); ctx.fill(); }
        ctx.restore(); p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr;
      });
      if(elapsed<durationMs) requestAnimationFrame(frame);
      else { c.style.display='none'; }
    });
  }
})();
</script>
</body>
</html>
